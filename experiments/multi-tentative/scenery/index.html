<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCA Graph Visualization</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        margin: 0;
        padding: 20px;
        background: #f5f5f5;
        max-width: 1200px;
        margin: 0 auto;
    }
    h1 {
        color: #1976d2;
        margin-bottom: 30px;
    }
    .graph-row {
        background: white;
        margin-bottom: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: flex;
        overflow: hidden;
    }
    .graph-svg {
        width: 340px;
        height: 340px;
        padding: 20px;
        flex-shrink: 0;
        border-right: 1px solid #e0e0e0;
    }
    .graph-json {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        max-height: 380px;
        background: #f8f8f8;
    }
    .graph-json pre {
        margin: 0;
        font-family: "Courier New", Courier, monospace;
        font-size: 11px;
        line-height: 1.4;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    .graph-title {
        font-weight: bold;
        margin-bottom: 10px;
        color: #1976d2;
        font-size: 16px;
    }
    #loading {
        text-align: center;
        color: #666;
        padding: 40px;
        font-size: 18px;
    }
    .error {
        color: #d32f2f;
        padding: 20px;
        background: #ffebee;
        border-radius: 4px;
        margin: 20px 0;
    }
    .svg-latex {
        /* This is the div inside the foreignObject */
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        padding: 0; /* Removed padding for perfect centering */
        box-sizing: border-box;
        border-radius: 0.25rem;
        font-size: 0.875rem;
    }
    
    foreignObject .katex {
        /* Reset KaTeX's default styling to allow flexbox to work */
        margin: 0 !important;
        padding: 0 !important;
        line-height: 1 !important;
        font-size: inherit !important;
        color: inherit !important;
        text-align: center;
    }
    foreignObject div {
        /* The div needs to fill the foreignObject and allow color inheritance */
        height: 100%;
        width: 100%;
        color: inherit !important;
    }
</style>
</head>
<body>
    <h1>ðŸŽ¨ PCA Graph Visualization</h1>
    
    <div id="loading">Loading Pyodide and graphs...</div>
    <div id="error-container"></div>
    <div id="graphs-container"></div>

    <!-- Cache busting: Add timestamp to force reload -->
    <script type="module">
        // ===== URL CONFIGURATION =====
        // All URLs are declared here for easy configuration
        
        // Nagini import path
        const NAGINI_PATH = '../../../src/nagini.js';
        // const NAGINI_PATH = 'http://127.0.0.1:8010/src/nagini.js';
        
        // Worker path for Pyodide
        const WORKER_PATH = '../../../src/pyodide/worker/worker-dist.js';
        // const WORKER_PATH = 'http://127.0.0.1:8010/src/pyodide/worker/worker-dist.js';
        
        // Base URL for loading Python files
        // NOTE: Workers require absolute URLs, relative paths won't work in worker context
        const PYTHON_FILES_BASE = 'http://127.0.0.1:8010/experiments/multi-tentative/';
        // const PYTHON_FILES_BASE = '../';  // This only works in main thread, not in workers
        
        // KaTeX CDN URLs (keeping as external CDN)
        const KATEX_JS_URL = 'https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js';
        const KATEX_CSS_URL = 'https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css';
        
        // ===== END URL CONFIGURATION =====
        
        import { Nagini } from '../../../src/nagini.js';
        
        let manager;
        let allGraphs = {};
        
        async function main() {
            try {
                // Initialize Nagini with Pyodide backend
                
                // Python files to load - ALL 17 GRAPHS INCLUDED
                const pythonFiles = [
                    'pca_graph_viz/__init__.py',
                    'pca_graph_viz/tests/__init__.py',
                    'pca_graph_viz/core/__init__.py',
                    'pca_graph_viz/core/svg_utils.py',
                    'pca_graph_viz/core/color_utils.py',
                    'pca_graph_viz/models/__init__.py',
                    'pca_graph_viz/models/line_model.py',
                    'pca_graph_viz/models/curve_model.py',
                    'pca_graph_viz/models/line_object.py',
                    'pca_graph_viz/models/foreign_object.py',
                    'pca_graph_viz/tests/graphs/__init__.py',
                    'pca_graph_viz/graphs/__init__.py',
                    'pca_graph_viz/graphs/graph1.py',
                    'pca_graph_viz/graphs/graph2.py',
                    'pca_graph_viz/graphs/graph3.py',
                    'pca_graph_viz/graphs/graph4.py',
                    'pca_graph_viz/graphs/graph5.py',
                    'pca_graph_viz/graphs/graph6.py',
                    'pca_graph_viz/graphs/graph7.py',
                    'pca_graph_viz/graphs/graph8.py',
                    'pca_graph_viz/graphs/graph9.py',
                    'pca_graph_viz/graphs/graph10.py',
                    'pca_graph_viz/graphs/graph11.py',
                    'pca_graph_viz/graphs/graph12.py',
                    'pca_graph_viz/graphs/graph13.py',
                    'pca_graph_viz/graphs/graph14.py',
                    'pca_graph_viz/graphs/graph15.py',
                    'pca_graph_viz/graphs/graph16.py',
                    'pca_graph_viz/graphs/graph17.py',
                ];
                
                // Prepare files for Nagini
                const filesToLoad = pythonFiles.map(file => ({
                    url: `${PYTHON_FILES_BASE}${file}`,
                    path: file
                }));
                
                // Create Nagini manager with Pyodide backend
                console.log('ðŸš€ Initializing Nagini with Pyodide backend...');
                manager = await Nagini.createManager(
                    'pyodide',                                          // Backend
                    ["numpy", "svgwrite"],                             // Python packages
                    [],                                                 // Micropip packages
                    filesToLoad,                                        // Files to load
                    WORKER_PATH                                         // Bundled worker path
                );
                
                // Wait for initialization
                await Nagini.waitForReady(manager);
                console.log('âœ… Nagini PyodideManager ready!');
                
                // Load all graphs
                await loadAllGraphs();
                
                // Hide loading
                document.getElementById('loading').style.display = 'none';
                
                // Display all graphs only if we have loaded some
                if (Object.keys(allGraphs).length > 0) {
                    displayAllGraphs();
                } else {
                    showError('No graphs were loaded successfully!');
                }
                
            } catch (error) {
                showError(`Initialization error: ${error.message}`);
                console.error(error);
            }
        }
        
        async function loadAllGraphs() {
            // Load each graph in its own namespace
            allGraphs = {};
            
            // List of all 17 graphs
            const graphNumbers = Array.from({length: 17}, (_, i) => i + 1);
            
            console.log('Loading graphs individually...');
            
            for (const num of graphNumbers) {
                const graphId = `graph${num}`;
                try {
                    // Create a unique namespace for each graph
                    const namespace = { __name__: `graph${num}_namespace` };
                    
                    const result = await manager.executeAsync(`load_${graphId}.py`, `
import json
from pca_graph_viz.graphs.graph${num} import get_graph_dict

# Get the graph dictionary
graph_dict = get_graph_dict()

# Send it back via missive
missive({"graph": graph_dict})
print(f"Loaded ${graphId} successfully!")
                    `, namespace);
                    
                    if (result.missive) {
                        // Parse missive if it's a string
                        const missiveData = typeof result.missive === 'string' 
                            ? JSON.parse(result.missive) 
                            : result.missive;
                        
                        if (missiveData.graph) {
                            allGraphs[graphId] = missiveData.graph;
                            console.log(`âœ… Loaded ${graphId}: ${missiveData.graph.title || 'No title'}`);
                        } else {
                            console.error(`No graph data in missive for ${graphId}:`, missiveData);
                        }
                    } else {
                        console.error(`No missive in result for ${graphId}:`, result);
                    }
                } catch (error) {
                    console.error(`Error loading ${graphId}:`, error);
                }
            }
            
            console.log(`Total graphs loaded: ${Object.keys(allGraphs).length}`);
        }
        
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.getElementById('error-container').appendChild(errorDiv);
        }
        
        async function displayGraph(graphId, graphDict, container) {
            const row = document.createElement('div');
            row.className = 'graph-row';
            
            // SVG container
            const svgContainer = document.createElement('div');
            svgContainer.className = 'graph-svg';
            svgContainer.innerHTML = `<div class="graph-title">${graphDict.title || graphId}</div>`;
            
            // JSON container
            const jsonContainer = document.createElement('div');
            jsonContainer.className = 'graph-json';
            jsonContainer.innerHTML = `<div class="graph-title">JSON Entry Point</div><pre>${JSON.stringify(graphDict, null, 2)}</pre>`;
            
            row.appendChild(svgContainer);
            row.appendChild(jsonContainer);
            container.appendChild(row);
            
            try {
                // Generate SVG using Python via Nagini with unique namespace
                const namespace = { __name__: `render_${graphId}_namespace` };
                
                const result = await manager.executeAsync(`render_${graphId}.py`, `
import json
from pca_graph_viz import graph_from_dict

# Parse the graph dictionary
graph_dict = json.loads(${JSON.stringify(JSON.stringify(graphDict))})

# Generate SVG
svg_output = graph_from_dict(graph_dict)

# Send back via missive
missive({"svg": svg_output})
print(f"Rendered ${graphId} successfully")
                `, namespace);
                
                console.log(result.stdout);
                
                // Parse missive if it's a string
                const missiveData = typeof result.missive === 'string' 
                    ? JSON.parse(result.missive) 
                    : result.missive;
                
                const svg = missiveData.svg;
                
                const svgDiv = document.createElement('div');
                svgDiv.innerHTML = svg;
                svgContainer.appendChild(svgDiv);
                
                // Process LaTeX in foreign objects
                setTimeout(() => {
                    const foreignObjects = svgContainer.querySelectorAll('foreignObject');
                    foreignObjects.forEach(fo => {
                        const divs = fo.querySelectorAll('div.svg-latex');
                        divs.forEach(div => {
                            const latex = div.textContent.trim();
                            console.log('Processing LaTeX:', latex);
                            
                            if (latex) {
                                try {
                                    // Save the original styles
                                    const originalBgColor = div.style.backgroundColor;
                                    const originalColor = div.style.color;
                                    
                                    // Render LaTeX
                                    div.innerHTML = '';
                                    katex.render(latex, div, {
                                        throwOnError: false,
                                        displayMode: false
                                    });
                                    
                                    // Reapply the original styles
                                    if (originalBgColor) {
                                        div.style.backgroundColor = originalBgColor;
                                    }
                                    if (originalColor) {
                                        // Apply color to the KaTeX elements
                                        const katexElements = div.querySelectorAll('.katex, .katex *');
                                        katexElements.forEach(el => {
                                            el.style.color = originalColor;
                                        });
                                    }
                                } catch (e) {
                                    console.error('KaTeX error:', e);
                                    // If KaTeX fails, restore original text
                                    div.textContent = latex;
                                }
                            }
                        });
                    });
                }, 100);
                
            } catch (error) {
                console.error(`Error displaying ${graphId}:`, error);
                svgContainer.innerHTML += `<div class="error">Error: ${error.message}</div>`;
            }
        }
        
        function displayAllGraphs() {
            const container = document.getElementById('graphs-container');
            container.innerHTML = '';
            
            // Check if allGraphs is properly loaded
            if (!allGraphs || typeof allGraphs !== 'object') {
                showError('ERROR: Graphs data not loaded properly!');
                console.error('allGraphs is:', allGraphs);
                return;
            }
            
            // Verify we have all 17 graphs
            const graphCount = Object.keys(allGraphs).length;
            if (graphCount !== 17) {
                showError(`WARNING: Expected 17 graphs but found ${graphCount}!`);
                console.error('Graphs loaded:', Object.keys(allGraphs));
            } else {
                console.log('âœ… All 17 graphs loaded successfully!');
            }
            
            // Display all graphs
            Object.entries(allGraphs).forEach(([graphId, graphDict]) => {
                displayGraph(graphId, graphDict, container);
            });
        }
        
        // Start the app
        window.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, starting main()...');
            main().catch(error => {
                console.error('Fatal error in main:', error);
                showError(`Fatal error: ${error.message}`);
            });
        });
    </script>
</body>
</html>