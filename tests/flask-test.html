<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="Simple test for Nagini Flask integration" />
    <meta name="keywords" content="nagini, flask, test, python" />
    <title>Nagini Flask Test</title>
  </head>
  <body>
    <h1>Nagini Flask Integration Test</h1>
    <button onclick="testNagini()">Test Nagini</button>
    <pre id="output"></pre>

    <script type="module">
        import {
            Nagini
        } from 'http://127.0.0.1:8010/src/nagini.js';

        async function createBlobWorkerUrl(workerPath) {
            try {
                // Fetch the worker module
                const response = await fetch(workerPath);
                if (!response.ok) {
                    throw new Error(`Failed to fetch worker: ${response.status} ${response.statusText}`);
                }
                const workerCode = await response.text();

                // Create a blob with the bundled worker code directly
                const blob = new Blob([workerCode], {
                    type: 'application/javascript'
                });
                const blobUrl = URL.createObjectURL(blob);

                return blobUrl;
            } catch (error) {
                throw new Error(`Failed to create blob worker URL: ${error.message}`);
            }
        }

        window.testNagini = async function() {
            const output = document.getElementById('output');
            output.textContent = 'Testing Nagini...\n';

            try {
                // Create blob worker URL to avoid CORS issues - using webpack bundled worker
                const workerPath = "http://127.0.0.1:8010/src/pyodide/worker/worker-dist.js";
                const blobWorkerUrl = await createBlobWorkerUrl(workerPath);

                // Create manager
                const manager = await Nagini.createManager(
                    'pyodide', // backend
                    ["numpy"], // packages
                    [], // filesToLoad
                    "http://127.0.0.1:8010/src/pyodide/python/pyodide_init.py", // pyodideInitPath
                    blobWorkerUrl // pass the blob URL as workerPath
                );

                output.textContent += 'Manager created ✓\n';

                // Wait for ready
                await Nagini.waitForReady(manager);
                output.textContent += 'Manager ready ✓\n';

                // Execute simple Python
                const result = await manager.executeAsync('test.py', `
import numpy as np
print("Hello from Nagini!")
arr = np.array([1, 2, 3])
print(f"NumPy array: {arr}")
print(f"Sum: {np.sum(arr)}")
`);

                output.textContent += 'Python executed ✓\n';
                output.textContent += 'Output:\n' + result.stdout;
                output.textContent += '\n✅ ALL TESTS PASSED';

            } catch (error) {
                output.textContent += `❌ ERROR: ${error.message}`;
            }
        };
    </script>
  </body>
</html>
