#!/bin/bash
# Pre-push hook to run scenery tests and check for failures before pushing a tag.

# Check if we're pushing a tag
if [[ "$1" == "origin" ]] && [[ "$2" == refs/tags/* ]]; then
    tag_name=$(basename "$2")
    echo "Pushing tag '$tag_name', running scenery tests..."

    # Navigate to the scenery directory
    cd scenery

    # Activate virtual environment
    source env/bin/activate

    # Define output path
    output_path="critics/$tag_name.json"

    # Run tests (it's okay if this command fails; we check the JSON output)
    python run_tests.py "$output_path"

    # Check the JSON output for flops or glitches
    if grep -q '"main_critic": "flop"' "$output_path" || grep -q '"main_critic": "glitch"' "$output_path"; then
        echo "❌ Failing tests found in '$output_path'. Aborting push."
        echo "   Please fix the 'flop' (assertion failure) or 'glitch' (runtime error) tests."
        exit 1
    fi

    echo "✅ All critical tests passed. Results saved to $output_path"
    cd ..
fi

exit 0 